<?xml version="1.0" encoding="utf-8" ?>
<SqlList>
  <SearchTransportReq>
		<MainSQL>
      SELECT CC.CSTID
      , H.FROM_PORT_iD AS 요청포트
      , H.TO_PORT_ID AS 목적포트
      , H.CSTSTAT AS 상태
      , CC.ABNORM_TRF_RSN_CODE AS ATRC
      , CC.CURR_LOTID AS LOTID
      , WA.LANE_ID AS LANE_ID
      , CONVERT(CHAR(23), H.INSDTTM, 20) AS 요청시각
      , CONVERT(CHAR(23), H.UPDDTTM, 20) AS 수정시각
      , H.TRF_CODE
      , W.ROUTID AS ROUT
      , W.PROCID AS PROCID
      , W.WIPSTAT AS WIP
      , H.RTD_RULE_ID
      , H.CMD_STAT_CODE AS 진행상태
      , H.INSUSER AS 요청
      , H.REQ_SEQNO AS 순번
      , H.CNCL_REQ_FLAG AS 취소
      , (CASE WHEN (DATEDIFF(minute, H.INSDTTM, GETDATE())>=60) THEN '1' ELSE 'O' END)  AS CMDCHK
      , H.RSPN_CODE AS RSPN
      , C.CMCDNAME AS ERR_MSG
      FROM CARRIER CC with(nolock)
      INNER JOIN TB_MHS_TRF_CMD H with(nolock) ON H.CSTID = CC.CSTID
      LEFT JOIN WIP W with(nolock) ON W.LOTID = CC.CURR_LOTID
      LEFT JOIN WIPATTR WA with(nolock) ON WA.LOTID = W.LOTID
      LEFT JOIN COMMONCODE C with(nolock) ON C.CMCDTYPE = 'TRF_REQ_ERR_CODE' AND C.CMCODE = H.RSPN_CODE
      WHERE
      AND H.CMD_STAT_CODE IN (@CMD_STAT_CODE_LIST)
      AND ISNULL(H.CNCL_REQ_FLAG, '') NOT IN ('Y', 'S')
    </MainSQL>
    <Option>
			<Option1 type="if" condition="not_equal" key="LaneId" dataType="string" default="">
				AND WA.LANE_ID LIKE @LANE_ID
			</Option1>
			<Option2 type="cststat"  condition="cststat" key="CstStat" dataType="string" default="">
				AND H.CSTSTAT = @CSTSTAT
			</Option2>
			<Option3 type="if" condition="not_equal" key="CstId" dataType="string" default="">
				AND H.CSTID LIKE @CSTID
			</Option3>
			<Option4 type="if" condition="not_equal" key="ReqPortId" dataType="string" default="">
				AND H.FROM_PORT_ID LIKE @ReqPortId
			</Option4>
			<Option5 type="if" condition="not_equal" key="ToPortId" dataType="string" default="">
				AND H.TO_PORT_ID LIKE @ToPortId
			</Option5>
			<Option6 type="if" condition="equal" key="isFaulty" dataType="bool" default="True">
				AND CC.ABNORM_TRF_RSN_CODE = 'STACK_VALID_ERROR 
			</Option6>
			<Option7 type="none" condition="" key="" dataType="" default="" >
				<![CDATA[AND H.INSUSER <> 'MCS(SYNC)' ORDER BY H.INSDTTM DESC]]>
			</Option7>
		</Option>
	</SearchTransportReq>
  <SearchTrf>
    <MainSQL>
      select
      PORT_ID
      , EVENT_TYPE_CODE as ETC
      , TRF_END_CODE as TEC 
      , EVENT_CODE
      , INSDTTM
      from TB_MHS_TRF_EVENT_HIST with (NOLOCK) WHERE TRF_CODE = @TRF_CODE
      order by INSDTTM desc
    </MainSQL>
    <Option>
    </Option>
  </SearchTrf>
  <ReqInfomation>
		<MainSQL>
				SELECT
				   REQ.REQ_SEQNO as 번호
				 , REQ.CSTID AS CSTID 
				 , REQ.CSTSTAT as 상태
				 , REQ.EQPTID AS 설비명
				 , REQ.PORT_ID AS 포트명
				 , REQ.REQ_TYPE_CODE AS 요청코드
				 , REQ.PRCS_TYPE_CODE AS 코드
				 , REQ.RTD_RULE_ID
				 , REQ.INSUSER AS 요청자
				 , CONVERT(CHAR(23), REQ.INSDTTM, 20) AS INSDTTM
				 , CONVERT(CHAR(23), REQ.UPDDTTM, 20) AS UPDDTTM
				 , REQ.REQ_STAT_CODE as 요청상태
				 , REQ.REQ_SEQS
				 , REQ.RTD_EXEC_LOG_CNTT
				 , REQ.ERR_CODE
				 , C.CMCDNAME AS ERR_DESC
				FROM TB_MHS_TRF_REQ REQ with(nolock)
				LEFT JOIN COMMONCODE     C with(nolock) ON C.CMCDTYPE = 'TRF_REQ_ERR_CODE' AND C.CMCODE = REQ.ERR_CODE
				WHERE 1 = 1 
			</MainSQL>
		<Option>
			<Option1 type="none" condition="" key="" dataType="" default="">
				AND REQ.CSTID like @CSTID 
			</Option1>
      <Option2 type="none" condition="" key="" dataType="" default="">
				 AND CONVERT(CHAR(10), REQ.INSDTTM, 20) BETWEEN @StartDate AND @EndDate 
			</Option2>
      <Option3 type="none" condition="" key="" dataType="" default="">
				AND REQ.EQPTID LIKE @EQPTID 
			</Option3>
      <Option4 type="none" condition="" key="" dataType="" default="">
			   AND REQ.RTD_RULE_ID LIKE @RULEID
			 </Option4>
			<Option5 type="none" condition="" key="" dataType="" default="">
				AND REQ.REQ_STAT_CODE = 'QUERY' 
			</Option5>
			<Option6 type="none" condition="" key="" dataType="" default="">
				ORDER BY REQ.CSTID, REQ.UPDDTTM DESC 
			</Option6>
		</Option>
	</ReqInfomation>
	<SearchTransfer>
		<MainSQL>
			SELECT
			CSTID
			, FROM_EQPTID
			, FROM_PORT_iD
			, TO_EQPTID
			, TO_PORT_ID
			, CSTSTAT
			, RTD_RULE_ID
			, CMD_STAT_CODE
			, INSUSER
			, CONVERT(CHAR(23), INSDTTM, 20) AS INSDTTM
			, CONVERT(CHAR(23), UPDDTTM, 20) AS UPDDTTM
			, (CASE WHEN (DATEDIFF(minute, INSDTTM, GETDATE())>=60) THEN '1' ELSE 'O' END)  AS CMDCHK
			FROM TB_MHS_TRF_CMD_HIST with(nolock)
			WHERE INSDTTM BETWEEN @StartDate AND @EndDate
		</MainSQL>
		<Option>
      <Option1 type="none" condition="" key="" dataType="" default="">
				AND CSTID LIKE @CSTID
			</Option1>
      <Option2 type="none" condition="" key="" dataType="" default="">
				AND FROM_PORT_ID LIKE @ReqEQP
			</Option2>
      <Option3 type="none" condition="" key="" dataType="" default="">
				AND TO_PORT_ID LIKE @ToEQP
			</Option3>
      <Option4 type="none" condition="" key="" dataType="" default="">
				AND CSTSTAT = @CSTSTAT
			</Option4>
      <Option5 type="none" condition="" key="" dataType="" default="">
				AND CMD_STAT_CODE = @MovingState
			</Option5>
      <Option6 type="none" condition="" key="" dataType="" default="">
				AND RTD_RULE_ID = @RuleId
			</Option6>			
		</Option>
	</SearchTransfer>
	<SearchReq>
		<MainSQL>
			WITH TT_DATA AS (
				SELECT top 1000 *
				FROM TB_MHS_TRF_REQ_HIST with(nolock)
				WHERE INSDTTM BETWEEN @StartDate AND @EndDate
					AND CSTID LIKE @CSTID
					AND PRCS_TYPE_CODE like @PRCS_TYPE_CODE
				ORDER BY INSDTTM  DESC
			)
			SELECT
			CSTID
			, CSTSTAT AS 상태
			, REQ_STAT_CODE
			, EQPTID
			, PORT_ID
			, REQ_TYPE_CODE AS 요청
			, CONVERT(CHAR(23), INSDTTM, 20) AS INSDTTM
			, CONVERT(CHAR(23), UPDDTTM, 20) AS UPDDTTM
			, PRCS_TYPE_CODE
			, RTD_RULE_ID
			, REQ_SEQS
			, ERR_CODE
			, RTD_EXEC_LOG_CNTT
			, INSUSER
			, REQ_SEQNO
			FROM TT_Data with(nolock)
			ORDER BY REQ_SEQNO DESC
		</MainSQL>
		<Option>
			<Option1 type="none" condition="" key="" dataType="" default="">
				AND CSTID LIKE @CSTIDV
			</Option1>
			<Option2 type="none" condition="" key="" dataType="" default="">
        AND PORT_ID LIKE @PORT_ID
      </Option2>
      <Option3 type="none" condition="" key="" dataType="" default="">
        AND CSTSTAT = @CSTSTAT
      </Option3>
      <Option4 type="none" condition="" key="" dataType="" default="">
				ORDER BY INSDTTM DESC
			</Option4>
		</Option>
	</SearchReq>
	<SearchDeleteTransfer>
		<MainSQL>
			SELECT
			CSTID
			, FROM_EQPTID
			, FROM_PORT_iD
			, TO_EQPTID
			, TO_PORT_ID
			, CSTSTAT
			, RTD_RULE_ID
			, CMD_STAT_CODE
			, INSUSER
			, CONVERT(NVARCHAR(20), MAX(INSDTTM),20) AS LASTINSDTTM
			, COUNT(CSTID)  AS CNT
			FROM TB_MHS_TRF_CMD_HIST with(nolock)
			WHERE CONVERT(NVARCHAR(10), INSDTTM, 20) BETWEEN @StartDate AND @EndDate
			AND CMD_STAT_CODE = 'DELETE'
			GROUP BY CSTID, FROM_EQPTID, FROM_PORT_ID, TO_EQPTID, TO_PORT_ID, CSTSTAT, RTD_RULE_ID, CMD_STAT_CODE, INSUSER
			ORDER BY MAX(INSDTTM) DESC
		</MainSQL>
		<Option>
			<Option1  type="none" condition="" key="" dataType="" default="">
				AND (EXCT_MSG LIKE @ErrText OR EXCT_TYPE LIKE @ErrText)
			</Option1>
      <Option2 type="none" condition="" key="" dataType="" default="">
				ORDER BY INSDTTM DESC
			</Option2>
		</Option>
	</SearchDeleteTransfer>
	<CstActHistSearch>
		<MainSQL>
			SELECT
			CSTID
			, LOAD_REP_CSTID
			, ACTID
			, CONVERT(CHAR(23), ACTDTTM, 20)  AS ACTDTTM
			, CSTSTAT
			, EQPTID
			, PROCID
			, LOTID
			, TRF_STAT_CODE
			, CST_LOAD_LOCATION_CODE
			, PORT_ID
			, RACK_ID
			, CSTIUSE
			, INSUSER
			, CONVERT(CHAR(23), INSDTTM, 20) AS INSDTTM
			, CONVERT(CHAR(23), UPDDTTM, 20) AS UPDDTTM
			FROM tb_sfc_cst_act_hist with(nolock)
			where ACTDTTM BETWEEN @StartDate AND @EndDate
		</MainSQL>
		<Option>
      <Option1 type="none" condition="" key="" dataType="" default="">
				AND EQPTID like @EQPTID
			</Option1>
      <Option2 type="none" condition="" key="" dataType="" default="">
				AND CSTID like @CSTID
			</Option2>
      <Option3 type="none" condition="" key="" dataType="" default="">
				ORDER BY ACTDTTM DESC
			</Option3>
		</Option>
	</CstActHistSearch>
	<CstEventHistSearch>
		<MainSQL>
			SELECT
			CSTID
			, CSTSTAT as 상태
			, LOTID
			, PROCID
			, EQPTID
			, PORT_ID
			, RACK_ID
			, EVENT_CODE
			, EVENT_TYPE_CODE as ETC
			, TRF_END_CODE AS TEC
			, FINL_TO_EQPTID as EQPT_ID
			, FINL_TO_PORT_ID as PORT_ID
			, INSUSER
			, CONVERT(CHAR(23), INSDTTM, 20)  AS INSDTTM
			, CONVERT(CHAR(23), UPDDTTM, 20)  AS UPDDTTM
			FROM TB_MHS_TRF_EVENT_HIST with(nolock)
			where CSTID like @CSTID
			and INSDTTM BETWEEN @StartDate AND @EndDate
			ORDER BY INSDTTM DESC
		</MainSQL>
		<Option>
		</Option>
	</CstEventHistSearch>
	<SearchLnsPkgLot>
		<MainSQL>
			SELECT
				C.CSTID
				, C.CSTSTAT as 유형
				, TMR.EQPTID as 설비
				, TMR.RACK_ID as 위치
				, TMR.RACK_STAT_CODE as 상태
				, 'RACK IN' as 자재유형
				, TSFD.DEMAND_TYPE
				, L.LOTTYPE as LT
				, WA.LOTID
				, W.WOID
				, W.PRODID
				, W.PROCID
			FROM WIPATTR WA (NOLOCK)
			INNER JOIN TB_MCS_RACK TMR (NOLOCK)
				ON WA.CSTID = TMR.MCS_CST_ID
			INNER JOIN Carrier c (NOLOCK)
				ON C.CSTID = TMR.MCS_CST_ID
			INNER JOIN LOT L (NOLOCK)
				ON L.LOTID = WA.LOTID
			INNER JOIN WIP W (NOLOCK)
				ON W.LOTID = WA.LOTID
			INNER JOIN TB_SFC_FP_DETL_PLAN TSFD (NOLOCK)
				ON TSFD.WOID = W.WOID
			UNION ALL
			SELECT
				C.CSTID
				, C.CSTSTAT as 유형
				, THTR.EQPTID as 설비
				, THTR.PORT_ID as 위치
				, THTR.REQ_STAT_CODE as 상태
				, 'REQ IN' as 자재유형
				, TSFD.DEMAND_TYPE
				, L.LOTTYPE as LT
				, WA.LOTID
				, W.WOID
				, W.PRODID
				, W.PROCID
			FROM WIPATTR WA (NOLOCK)
			INNER JOIN TB_MHS_TRF_REQ THTR (NOLOCK)
				ON WA.CSTID = THTR.CSTID
			INNER JOIN Carrier c (NOLOCK)
				ON C.CSTID = THTR.CSTID
			INNER JOIN LOT L (NOLOCK)
				ON L.LOTID = WA.LOTID
			INNER JOIN WIP W (NOLOCK)
				ON W.LOTID = WA.LOTID
			INNER JOIN TB_SFC_FP_DETL_PLAN TSFD (NOLOCK)
				ON TSFD.WOID = W.WOID
		</MainSQL>
		<Option>
		</Option>
	</SearchLnsPkgLot>
	<SearchLnsPkgEqp>
		<MainSQL>
			select
			EA.EQPTID
			, EA.WO_DETL_ID
			, TSFD.DEMAND_TYPE
			, EA.EQPT_OPER_MODE as EOM
			, EA.SPCL_LOT_GNRT_FLAG as SLGF
			, LT.LOTTYPE as LT
			, PILOT_PROD_DIVS_CODE as PPDC
			from TB_SFC_FP_DETL_PLAN TSFD (NOLOCK)
			INNER JOIN EioAttr EA (NOLOCK)
			ON EA.WO_DETL_ID = TSFD.WOID
			INNER JOIN LotType LT (NOLOCK)
			ON LT.DEMAND_TYPE = TSFD.DEMAND_TYPE
		</MainSQL>
		<Option>
		</Option>
	</SearchLnsPkgEqp>
  <SearchCstInfo>
    <MainSQL>
      SELECT C.CSTID
      , C.CSTSTAT
      , C.LOAD_REP_CSTID
      , C.CST_LOAD_LOCATION_CODE
      , C.CURR_RACK_ID
      , C.CURR_LOTID
      , C.ABNORM_TRF_RSN_CODE
      , C.EQPT_CUR AS EQPTID
      , C.PORT_CUR AS PORT_ID
      , W.ROUTID
      , W.WIPSTAT
      , L.LOTTYPE
      , WA.DAY_GR_LOTID AS ASSY_LOTID
      , WA.SPCL_FLAG
      , WA.SMPL_ISS_TYPE_CODE
      , WA.LOT_DETL_TYPE_CODE
      , WA.DFCT_LIMIT_OVER_FLAG
      , WA.SPCL_NOTE
      , WA.FORM_SPCL_GR_ID
      , W.PROCID
      , C.TRAY_TYPE_CODE
      , CONVERT(CHAR(23), C.UPDDTTM, 20) AS UPDDTTM
      , WA.DFCT_OCCR_EQPTID
      , CONVERT(CHAR(23),WA.AGING_ISS_SCHD_DTTM, 20) AS AGING_ISS_SCHD_DTTM 
      , WA.SCRP_TRAY_FLAG
      , WA.TRAY_CNVR_BCR_SCAN_COUNT
      FROM Carrier C with(nolock)
      LEFT JOIN WIP W WITH(NOLOCK) ON C.CURR_LOTID = W.LOTID
      LEFT JOIN WIPATTR WA WITH(NOLOCK) ON WA.LOTID = W.LOTID
      LEFT JOIN LOT L WITH(NOLOCK) ON L.LOTID = WA.LOTID
      WHERE (LOAD_REP_CSTID LIKE @CSTID or C.CSTID LIKE @CSTID )
      ORDER BY UPDDTTM DESC,CST_LOAD_LOCATION_CODE DESC
    </MainSQL>
    <Option>
    </Option>
  </SearchCstInfo>
</SqlList>