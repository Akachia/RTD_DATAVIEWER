<?xml version="1.0" encoding="utf-8" ?>
<SearchRollCurrentSituation>
	<MainSQL>
			<![CDATA[
			DECLARE @SKID_USE_CHECK BIT =
			(
			SELECT IIF(COUNT(A.ATTRIBUTE1)=0,'FALSE','TRUE') AS SKID_UNUSE_FLAG
			  FROM EZMES.COMMONCODE A (NOLOCK)
			 WHERE A.CMCDTYPE = 'MHS_UNCHECK_SKID_BOBBIN_MAPPING'
			   AND A.CMCODE = 'EO'
			   AND A.CMCDIUSE = 'Y'
			   AND A.ATTRIBUTE1 = 'Y'
			)
			SELECT VP.S01 AS PRJT_NAME
			, IIF('EO' = 'SWW', NULL, VP.S08) AS 극성
			, EZMES.FN_GET_CMCODE_NAME('ko-KR', 'ELTR_TYPE_CODE', IIF('EO' = 'SWW', NULL, VP.S08)) AS ELTR_TYPE
			, WH.WH_ID AS EQPTID
			, EZMES.EZMES_FN_GET_NAME('ko-KR', E_WH.EQPTNAME) AS EQPTNAME
			, IIF('EO' = 'SWW', NULL, LA.PROD_VER_CODE) AS PROD_VER_CODE
			, VP.PRODID
			, IIF('EO' = 'SWW', NULL, ISNULL(LA.HALF_SLIT_SIDE,'A')) AS 무지부
			, IIF('EO' = 'SWW', NULL, ISNULL(WA.EM_SECTION_ROLL_DIRCTN , 'A')) AS 권치
			, IIF(IIF('EO' = 'SWW', NULL, ISNULL(LA.HALF_SLIT_SIDE,'A')) = 'A'
			, 'A'
			, EZMES.FN_GET_CMCODE_NAME('ko-KR', 'WRK_HALF_SLIT_SIDE', IIF('EO' = 'SWW', NULL, ISNULL(LA.HALF_SLIT_SIDE,'A')))) +
			'/' +
			IIF(IIF('EO' = 'SWW', NULL, ISNULL(WA.EM_SECTION_ROLL_DIRCTN , 'A')) = 'A'
			, 'A'
			, EZMES.FN_GET_CMCODE_NAME('ko-KR', 'EM_SECTION_ROLL_DIRCTN', IIF('EO' = 'SWW', NULL, ISNULL(WA.EM_SECTION_ROLL_DIRCTN, 'A')))) AS HALF_ROLL
			, COUNT(W.LOTID) AS LOT_TOTAL_QTY
			--, COUNT(W.LOTID) - SUM(IIF(W.WIPHOLD = 'Y', 1, 0)) - SUM(IIF(W.WIPHOLD <> 'Y' AND ISNULL(BR.FINL_HOLD_FLAG, 'N') = 'Y' , 1, 0))- SUM(IIF(W.WIPHOLD <> 'Y' AND ISNULL(WA.QMS_HOLD_FLAG,'N') = 'Y', 1, 0)) AS LOT_QTY
			, IIF('JRW' NOT IN ('NPW','LWW','SWW')
			, COUNT(W.LOTID) - SUM(IIF(W.WIPHOLD = 'Y', 1, 0)) - SUM(IIF(W.WIPHOLD <> 'Y' AND ISNULL(BR.FINL_HOLD_FLAG, 'N') = 'Y' , 1, 0))
			, COUNT(W.LOTID) - SUM(IIF(W.WIPHOLD = 'Y', 1, 0)) - SUM(IIF(W.WIPHOLD <> 'Y' AND ISNULL(WA.QMS_HOLD_FLAG, 'N') = 'Y' , 1, 0)))  AS LOT_QTY
			, SUM(IIF(W.WIPHOLD = 'Y', 1, 0)) AS LOT_HOLD_QTY
			, SUM(IIF(W.WIPHOLD <> 'Y' AND ISNULL(BR.FINL_HOLD_FLAG, 'N') = 'Y' , 1, 0)) AS LOT_HOLD_QMS_QTY
			, SUM(IIF(W.WIPHOLD <> 'Y' AND ISNULL(WA.QMS_HOLD_FLAG,'N') = 'Y', 1, 0)) AS LOT_HOLD_QMS_QTY_ETC -- 노칭완성, Lami대기, STK 완성
			FROM EZMES.TB_MCS_RACK R (NOLOCK)
			INNER LOOP JOIN EZMES.CARRIER C (NOLOCK) ON C.CSTID = R.MCS_CST_ID
			INNER LOOP JOIN EZMES.EQUIPMENT E (NOLOCK) ON E.EQPTID = R.EQPTID
			INNER LOOP JOIN EZMES.EQUIPMENTATTR EA (NOLOCK) ON EA.EQPTID = R.EQPTID
			INNER HASH JOIN (-- ※ CWA3동 전극창고(코터~롤프레스) RACK 에는 BOBBIN 이 들어간다. 그 외는 SKID 가 들어감
			-- ★ INFO_ID : RACK INFORMATION (SKID, BOBBIN ID, GROUP CSTID)
			-- ◆ CNT_ID  : LOT COUNT (BOBBIN ID)
			SELECT C.CSTTYPE, ISNULL(C.OUTER_CSTID, C.CSTID) AS INFO_ID, C.CSTID AS CNT_ID, C.CURR_LOTID, C.CSTINDTTM
			FROM EZMES.CARRIER C (NOLOCK)
			WHERE C.CSTTYPE = 'BB'                 -- 조립 BOBBIN
			AND (@SKID_USE_CHECK = 'TRUE' OR C.OUTER_CSTID IS NOT NULL)
			AND C.CSTIUSE = 'Y'
			UNION
			SELECT C.CSTTYPE, C.CSTID, C.CSTID, C.CURR_LOTID, C.CSTINDTTM
			FROM EZMES.CARRIER C (NOLOCK)
			WHERE C.CSTTYPE = 'EB'  -- 전극 BOBBIN
			AND C.OUTER_CSTID IS NULL   -- 점보롤창고 (OUTER_CSTID에 SKID가 없다.)
			AND C.CSTIUSE = 'Y'
			UNION
			SELECT C.CSTTYPE, ISNULL(C.GR_CSTID, C.CSTID), C.CSTID, C.CURR_LOTID, C.CSTINDTTM
			FROM EZMES.CARRIER C (NOLOCK)
			WHERE C.CSTTYPE = 'BK'  -- STK/PKG CELL
			AND C.CSTIUSE = 'Y'
			) CL ON C.CSTID = CL.INFO_ID
			INNER LOOP JOIN EZMES.TB_MMD_RACK MR (NOLOCK) ON MR.RACK_ID = R.RACK_ID
			INNER LOOP JOIN EZMES.TB_MMD_PRDT_WH WH (NOLOCK) ON WH.WH_ID = MR.WH_ID
			INNER LOOP JOIN EZMES.EQUIPMENT E_WH (NOLOCK) ON E_WH.EQPTID = WH.WH_ID
			INNER LOOP JOIN EZMES.EQUIPMENTATTR EA_WH (NOLOCK) ON EA_WH.EQPTID = WH.WH_ID
			INNER LOOP JOIN EZMES.WIP W (NOLOCK) ON W.LOTID = CL.CURR_LOTID
			INNER LOOP JOIN EZMES.WIPATTR WA (NOLOCK) ON WA.LOTID = W.LOTID
			INNER LOOP JOIN EZMES.LOT L (NOLOCK) ON L.LOTID = CL.CURR_LOTID
			INNER LOOP JOIN EZMES.LOTATTR LA (NOLOCK) ON LA.LOTID = CL.CURR_LOTID
			INNER LOOP JOIN EZMES.LOTTYPE LT (NOLOCK) ON LT.LOTTYPE = L.LOTTYPE
			/*튜닝 적용 - VIEW문 변경*/
			--INNER JOIN EZMES.VW_PRODUCT VP (NOLOCK) ON VP.PRODID = W.PRODID
			INNER LOOP JOIN EZMES.PRODUCT PR (NOLOCK) ON PR.PRODID = W.PRODID AND PR.PRODIUSE = 'Y'
			INNER LOOP JOIN EZMES.PRODUCTATTR VP (NOLOCK) ON VP.PRODID = PR.PRODID
			INNER LOOP JOIN EZMES.EQUIPMENTSEGMENT ES (NOLOCK) ON ES.EQSGID = E.EQSGID
			/*튜닝 적용 - 조인 변경*/
			--LEFT OUTER LOOP JOIN EZMES.TB_SFC_WIP_BLOCK_RSLT BR (NOLOCK) ON BR.LOTID = W.LOTID AND BR.BLOCK_TYPE_CODE = (SELECT ATTRIBUTE1 FROM EZMES.COMMONCODE WHERE CMCDTYPE = 'BLOCK_TYPE_BY_EQGR' AND CMCODE = EA.S70)
			LEFT OUTER LOOP JOIN EZMES.COMMONCODE CC WITH(NOLOCK) ON CC.CMCODE = EA.S70 AND CMCDTYPE = 'BLOCK_TYPE_BY_EQGR'
			LEFT OUTER LOOP JOIN EZMES.TB_SFC_WIP_BLOCK_RSLT BR (NOLOCK)ON BR.LOTID = W.LOTID AND BR.BLOCK_TYPE_CODE = CC.ATTRIBUTE1
			/*사용되지 않는 OUTER APPLY 삭제 필요
			OUTER APPLY(SELECT SUM(MC.DFCT_TAG_QTY) AS DFCT_TAG_QTY
			FROM EZMES.TB_SFC_MOVE_WIPREASONCOLLECT MC (NOLOCK)
			WHERE MC.LOTID = W.LOTID
			AND MC.ACTID = 'DEFECT_LOT' ) MC */
			WHERE 1 = 1
			AND R.USE_FLAG = 'Y'
			--   AND R.RACK_STAT_CODE = 'USING'
			AND R.ABNORM_STAT_CODE IS NULL
			AND C.CSTIUSE = 'Y'
			AND ISNULL(C.ABNORM_TRF_RSN_CODE, 'N') = 'N'
			AND MR.USE_FLAG = 'Y'
			AND WH.USE_FLAG = 'Y'
			AND E.EQPTIUSE = 'Y'
			AND E_WH.EQPTIUSE = 'Y'
			/*튜닝 적용 - VIEW문 변경으로 PRODUCT 테이블 조건으로  */
			--AND VP.PRODIUSE = 'Y'
			AND ES.EQSGIUSE = 'Y'
			AND ('NORMAL' != 'FIFO' OR     --조건출고
			W.WIPSTAT <> 'TERM' AND W.WIPQTY > 0 AND W.WIPHOLD = 'N' AND R.RACK_STAT_CODE = 'USING') --FIFO출고
			AND ES.AREAID IN (SELECT A.AREAID
			FROM EZMES.VW_AREA A
			INNER JOIN EZMES.VW_AREA B ON B.BLDG_CODE = A.BLDG_CODE AND B.AREAID = 'EO') -- 동
			AND EA.S70 = ISNULL('JRW', EA.S70)
			-- AND EA_WH.EQPTID = ISNULL(@EQPTID, EA_WH.EQPTID)
			--  AND COALESCE(EA_WH.S02, EA.S02, '') = COALESCE(@ELTR_TYPE_CODE, EA_WH.S02, EA.S02, '')
			GROUP BY VP.S01
			, IIF('EO' = 'SWW', NULL, VP.S08)
			, WH.WH_ID
			, E_WH.EQPTNAME
			, IIF('EO' = 'SWW', NULL, LA.PROD_VER_CODE)
			, VP.PRODID
			, IIF('EO' = 'SWW', NULL, ISNULL(LA.HALF_SLIT_SIDE,'A'))
			, IIF('EO' = 'SWW', NULL, ISNULL(WA.EM_SECTION_ROLL_DIRCTN , 'A'))]]></MainSQL>
	<Option/>
	<AdditionalVariable/>
	<Coloring>
		<EIOSTAT Red="255" Green="155" Blue="155" IsColoringColumn="false" IsTimeCompare="false">
			<F Red="255" Green="155" Blue="155" IsColoringRow="false"/>
			<T Red="255" Green="214" Blue="165" IsColoringRow="false"/>
			<U Red="255" Green="254" Blue="196" IsColoringRow="false"/>
			<W Red="203" Green="255" Blue="169" IsColoringRow="false"/>
			<R Red="203" Green="255" Blue="169" IsColoringRow="false"/>
		</EIOSTAT>
		<EIOIFMODE Red="255" Green="155" Blue="155" IsColoringColumn="false" IsTimeCompare="false">
			<OFF Red="255" Green="158" Blue="158" IsColoringRow="false"/>
			<ON Red="185" Green="243" Blue="252" IsColoringRow="false"/>
		</EIOIFMODE>
	</Coloring>
	<EventValues/>
</SearchRollCurrentSituation>