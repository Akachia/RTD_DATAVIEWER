<?xml version="1.0" encoding="utf-8" ?>
<SearchStockerInventory>
	<MainSQL>
		SELECT
		C.CSTID
		, (CASE WHEN C.LOAD_REP_CSTID IS NULL THEN C.CSTID ELSE C.LOAD_REP_CSTID END) AS 대표CST
		, CST_LOAD_LOCATION_CODE AS 단
		, CSTSTAT AS 유형
		, C.TRF_STAT_CODE
		, C.EQPT_CUR
		, CONVERT(CHAR(23), WA.AGING_ISS_SCHD_DTTM, 20) AS AGING_ISS_SCHD_DTTM
		, W.WIPSTAT
		, W.ROUTID
		, W.PROCID
		, ISNULL(RP2.PROCID, '')  AS NEXT_PROCID
		, ISNULL(RP2.LANE_ID, '')  AS NEXT_LANEID
		, W.LOTID
		, C.PORT_CUR
		, R.RACK_ID
		, R.RACK_STAT_CODE
		, R.ABNORM_STAT_CODE
		, WA.SMPL_ISS_TYPE_CODE
		, CONVERT(CHAR(23), r.UPDDTTM, 20) AS UPDDTTM_S
		, CONVERT(CHAR(23), C.UPDDTTM, 20) AS UPDDTTM_C
		, AGING_ISS_PRIORITY_NO
		, CASE WHEN DATEDIFF(minute, GETDATE(), AGING_ISS_SCHD_DTTM)> 0 THEN '0' ELSE '1' END AS OUTFLAG
		FROM  (
		SELECT
		C1.CSTID
		, C1.LOAD_REP_CSTID
		, C2.CURR_LOTID
		, C1.CSTSTAT
		, C1.TRF_STAT_CODE
		, C1.EQPT_CUR
		, C1.PORT_CUR
		, C1.CST_LOAD_LOCATION_CODE
		, C1.UPDDTTM
		FROM  (
		SELECT C.CSTID
		, ISNULL(C.LOAD_REP_CSTID, C.CSTID) AS LOAD_REP_CSTID
		, C.CURR_LOTID
		, C.CSTSTAT
		, C.TRF_STAT_CODE
		, C.EQPT_CUR
		, C.PORT_CUR
		, C.CST_LOAD_LOCATION_CODE
		, C.UPDDTTM
		FROM Carrier C WITH(NOLOCK)
		INNER JOIN EQUIPMENTATTR EA WITH(NOLOCK)  ON C.EQPT_CUR =  EA.EQPTID
		WHERE C.CURR_AREAID = @PLANT_ID AND EA.S70 = @STO_CODE
		) AS C1
		INNER JOIN CARRIER C2 WITH(NOLOCK) ON C1.LOAD_REP_CSTID = C2.CSTID
		) AS C
		LEFT JOIN TB_MCS_RACK R WITH(NOLOCK)
		ON R.MCS_CST_ID = C.LOAD_REP_CSTID
		LEFT JOIN WIP W WITH(NOLOCK)
		ON C.CURR_LOTID = W.LOTID
		LEFT JOIN WIPATTR WA WITH(NOLOCK)
		ON WA.LOTID = W.LOTID
		LEFT JOIN TB_MMD_FORM_ROUT_PROC RP WITH(NOLOCK)
		ON RP.ROUTID = W.ROUTID AND RP.PROCID = W.PROCID
		AND RP.USE_FLAG = 'Y'
		LEFT JOIN TB_MMD_FORM_ROUT_PROC RP2 WITH(NOLOCK)
		ON RP2.ROUTID = RP.ROUTID
		AND RP2.PROC_SEQNO = RP.PROC_SEQNO+1
		AND RP2.USE_FLAG = 'Y'
		WHERE 1=1
		+Option1
		+Option2
		+Option3
	</MainSQL>
	<Option>
		<Option1 type="CSTSTAT" condition="CSTSTAT" key="CSTSTAT" dataType="int" default="0">
				AND C.CSTSTAT = @CSTSTAT
			</Option1>
		<Option2 type="IF" condition="not_equal" key="TRF_STAT_CODE" dataType="string" default="">
				AND C.TRF_STAT_CODE like @TRF_STAT_CODE
			</Option2>
		<Option3 type="NONE" condition="NONE" key="NONE" dataType="NONE" default="NONE">
				ORDER BY
				CASE
				WHEN ISNULL(W.LOTID,'') ='' THEN '1'
				WHEN R.RACK_STAT_CODE ='DISABLE' THEN '2'
				WHEN (AGING_ISS_PRIORITY_NO='8' OR AGING_ISS_PRIORITY_NO='9') THEN '3'
				ELSE '4' END ASC, WA.AGING_ISS_SCHD_DTTM,  (CASE WHEN C.LOAD_REP_CSTID IS NULL THEN C.CSTID ELSE C.LOAD_REP_CSTID END), CST_LOAD_LOCATION_CODE
			</Option3>
	</Option>
	<AdditionalVariable>
		<PLANT_ID dataType="string" default=""/>
		<STO_CODE dataType="string" default=""/>
	</AdditionalVariable>
	<Coloring>
		<TRF_STAT_CODE Red="255" Green="155" Blue="155" IsColoringColumn="false" IsTimeCompare="false">
			<RESERVED Red="248" Green="255" Blue="219" IsColoringRow="true"/>
			<MOVING Red="179" Green="255" Blue="174" IsColoringRow="true"/>
		</TRF_STAT_CODE>
		<AGING_ISS_PRIORITY_NO Red="255" Green="155" Blue="155" IsColoringColumn="false" IsTimeCompare="false">		
		</AGING_ISS_PRIORITY_NO>
	</Coloring>
	<EventValues/>
</SearchStockerInventory>